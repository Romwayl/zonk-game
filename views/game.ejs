<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONK Multiplayer - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–≥—Ä–æ–∫–∏ -->
        <div class="players-panel">
            <h2>üéÆ –ò–≥—Ä–æ–∫–∏ <span id="playerCount">0/4</span></h2>
            <div id="playersList" class="player-list">
                <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            
            <div id="waitingArea" class="waiting-area" style="margin-top: 20px;">
                <h3>üë• –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</h3>
                <div id="roomInfo" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 0.9em; color: var(--text-secondary);">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</div>
                    <div id="roomCode" style="font-size: 1.5em; font-weight: bold; color: var(--primary); text-align: center; margin: 10px 0;"></div>
                    <button onclick="copyRoomCode()" class="btn btn-primary" style="width: 100%; padding: 10px;">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                    </button>
                </div>
                <button id="startGameBtn" onclick="startGame()" class="btn btn-success" style="width: 100%; padding: 15px; display: none;">
                    üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
                </button>
            </div>

            <div id="gameControls" style="display: none; margin-top: 20px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <div style="font-size: 0.9em; color: var(--text-secondary);">–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç:</div>
                    <div id="currentPlayer" style="font-size: 1.2em; font-weight: bold; color: var(--accent);"></div>
                </div>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="game-area">
            <div class="game-title">
                <h1>üé≤ ZONK MULTIPLAYER</h1>
                <div id="gameStatus" class="subtitle">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
            </div>

            <div id="winnerMessage" class="win-message" style="display: none;">
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ -->
            </div>

            <!-- –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ -->
            <div id="currentPlayerArea" style="display: none;">
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">–ú–æ–∏ –æ—á–∫–∏</div>
                        <div id="myScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–û—á–∫–∏ —Ä–∞—É–Ω–¥–∞</div>
                        <div id="roundScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–ö–æ—Å—Ç–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞</div>
                        <div id="diceToRoll" class="score-value">6</div>
                    </div>
                </div>

                <div id="diceContainer" class="dice-container" style="display: none;">
                    <!-- –ö–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <div id="gameMessages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä—ã -->
                </div>

                <div id="playerControls" class="controls" style="display: none;">
                    <button id="rollBtn" onclick="rollDice()" class="btn btn-primary">
                        üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏
                    </button>
                    <button id="takeBtn" onclick="takePoints()" class="btn btn-success">
                        üí∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—á–∫–∏
                    </button>
                    <button onclick="leaveGame()" class="btn btn-danger">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>

            <!-- –î–ª—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π -->
            <div id="observerArea" style="text-align: center; padding: 40px;">
                <div style="font-size: 1.5em; color: var(--text-secondary); margin-bottom: 20px;">
                    üëÄ –í—ã –Ω–∞–±–ª—é–¥–∞–µ—Ç–µ –∑–∞ –∏–≥—Ä–æ–π
                </div>
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">–•–æ–¥ –∏–≥—Ä–æ–∫–∞</div>
                        <div id="observerCurrentPlayer" class="score-value">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–û—á–∫–∏ —Ä–∞—É–Ω–¥–∞</div>
                        <div id="observerRoundScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–ö–æ—Å—Ç–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞</div>
                        <div id="observerDiceToRoll" class="score-value">6</div>
                    </div>
                </div>
                <div id="observerDice" class="dice-container" style="margin: 30px 0;">
                    <!-- –ö–æ—Å—Ç–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è -->
                </div>
                <button onclick="leaveGame()" class="btn btn-danger">
                    üö™ –í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã
                </button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏ —á–∞—Ç -->
        <div class="combinations-panel">
            <h2>üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏</h2>
            
            <div class="combo-grid">
                <div class="combo-item">
                    <div class="combo-value">100</div>
                    <div class="combo-desc">–ó–∞ –∫–∞–∂–¥—É—é 1</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">50</div>
                    <div class="combo-desc">–ó–∞ –∫–∞–∂–¥—É—é 5</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">1000</div>
                    <div class="combo-desc">3 –µ–¥–∏–Ω–∏—Ü—ã</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">200</div>
                    <div class="combo-desc">3 –¥–≤–æ–π–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">300</div>
                    <div class="combo-desc">3 —Ç—Ä–æ–π–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">400</div>
                    <div class="combo-desc">3 —á–µ—Ç–≤–µ—Ä–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">500</div>
                    <div class="combo-desc">3 –ø—è—Ç–µ—Ä–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">600</div>
                    <div class="combo-desc">3 —à–µ—Å—Ç–µ—Ä–∫–∏</div>
                </div>
            </div>

            <!-- –ß–∞—Ç -->
            <div class="chat-container" style="margin-top: 30px;">
                <h3>üí¨ –ß–∞—Ç</h3>
                <div id="chatMessages" style="height: 200px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendMessage()" class="btn btn-primary">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const roomId = '<%= roomId %>';
        let myPlayerId = null;
        let isMyTurn = false;

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        socket.emit('joinRoom', roomId);

        socket.on('gameState', (gameState) => {
            updateGameState(gameState);
        });

        socket.on('playerJoined', (player) => {
            addMessage('system', `–ò–≥—Ä–æ–∫ ${player.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
        });

        socket.on('playerLeft', (player) => {
            addMessage('system', `–ò–≥—Ä–æ–∫ ${player.username} –≤—ã—à–µ–ª`);
        });

        socket.on('chatMessage', (data) => {
            addMessage(data.player, data.message);
        });

        function updateGameState(gameState) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            updatePlayersList(gameState.players);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
            document.getElementById('roomCode').textContent = gameState.roomId;
            document.getElementById('playerCount').textContent = `${gameState.players.length}/4`;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            myPlayerId = socket.id;
            const myPlayer = gameState.players.find(p => p.id === myPlayerId);
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            isMyTurn = currentPlayer && currentPlayer.id === myPlayerId;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
            updateGameStatus(gameState, myPlayer, currentPlayer);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            updateControls(gameState, myPlayer, currentPlayer);
        }

        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.innerHTML = `
                    <span class="player-name">${player.username} ${player.id === myPlayerId ? ' (–í—ã)' : ''}</span>
                    <span class="player-score">${player.score}</span>
                `;
                playersList.appendChild(playerElement);
            });
        }

        function updateGameStatus(gameState, myPlayer, currentPlayer) {
            const gameStatus = document.getElementById('gameStatus');
            const winnerMessage = document.getElementById('winnerMessage');
            const waitingArea = document.getElementById('waitingArea');
            const gameControls = document.getElementById('gameControls');
            
            if (gameState.status === 'waiting') {
                gameStatus.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤... (${gameState.players.length}/4)`;
                waitingArea.style.display = 'block';
                gameControls.style.display = 'none';
                winnerMessage.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞ –∏ —è —Å–æ–∑–¥–∞—Ç–µ–ª—å
                document.getElementById('startGameBtn').style.display = 
                    gameState.players.length >= 2 ? 'block' : 'none';
            } else if (gameState.status === 'playing') {
                gameStatus.textContent = '–ò–≥—Ä–∞ –∏–¥–µ—Ç!';
                waitingArea.style.display = 'none';
                gameControls.style.display = 'block';
                winnerMessage.style.display = 'none';
                
                document.getElementById('currentPlayer').textContent = 
                    currentPlayer.username + (isMyTurn ? ' (–í—ã)' : '');
            } else if (gameState.status === 'finished') {
                gameStatus.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                winnerMessage.style.display = 'block';
                winnerMessage.innerHTML = `üèÜ –ü–û–ë–ï–î–ê!<br>${gameState.winner} –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç —Å ${currentPlayer.score} –æ—á–∫–∞–º–∏!`;
            }
        }

        function updateControls(gameState, myPlayer, currentPlayer) {
            const currentPlayerArea = document.getElementById('currentPlayerArea');
            const observerArea = document.getElementById('observerArea');
            
            if (myPlayer) {
                // –Ø –∏–≥—Ä–æ–∫
                currentPlayerArea.style.display = 'block';
                observerArea.style.display = 'none';
                
                document.getElementById('myScore').textContent = myPlayer.score;
                document.getElementById('roundScore').textContent = myPlayer.roundScore;
                document.getElementById('diceToRoll').textContent = myPlayer.diceToRoll;
                
                if (isMyTurn) {
                    document.getElementById('playerControls').style.display = 'grid';
                    document.getElementById('diceContainer').style.display = 'grid';
                    updateDice(myPlayer.dice, myPlayer.selected, true);
                    
                    document.getElementById('rollBtn').disabled = myPlayer.diceToRoll === 0;
                    document.getElementById('takeBtn').disabled = myPlayer.roundScore === 0 || 
                        (myPlayer.score === 0 && myPlayer.roundScore < 300);
                } else {
                    document.getElementById('playerControls').style.display = 'none';
                    document.getElementById('diceContainer').style.display = 'none';
                }
            } else {
                // –Ø –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
                currentPlayerArea.style.display = 'none';
                observerArea.style.display = 'block';
                
                document.getElementById('observerCurrentPlayer').textContent = currentPlayer.username;
                document.getElementById('observerRoundScore').textContent = currentPlayer.roundScore;
                document.getElementById('observerDiceToRoll').textContent = currentPlayer.diceToRoll;
                updateObserverDice(currentPlayer.dice, currentPlayer.selected);
            }
        }

        function updateDice(dice, selected, interactive) {
            const container = document.getElementById('diceContainer');
            container.innerHTML = '';
            
            dice.forEach((value, index) => {
                const diceElement = document.createElement('div');
                diceElement.className = `dice ${selected[index] ? 'selected' : ''}`;
                diceElement.innerHTML = `<span class="dice-value">${value}</span>`;
                
                if (interactive && isMyTurn && !selected[index]) {
                    diceElement.onclick = () => toggleDice(index);
                }
                
                container.appendChild(diceElement);
            });
        }

        function updateObserverDice(dice, selected) {
            const container = document.getElementById('observerDice');
            container.innerHTML = '';
            
            dice.forEach((value, index) => {
                const diceElement = document.createElement('div');
                diceElement.className = `dice ${selected[index] ? 'selected' : ''}`;
                diceElement.innerHTML = `<span class="dice-value">${value}</span>`;
                container.appendChild(diceElement);
            });
        }

        function addMessage(sender, message) {
            const chat = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '8px';
            messageElement.style.padding = '8px';
            messageElement.style.background = 'rgba(255,255,255,0.05)';
            messageElement.style.borderRadius = '5px';
            
            if (sender === 'system') {
                messageElement.innerHTML = `<span style="color: var(--accent);">‚ö° ${message}</span>`;
            } else {
                messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            }
            
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        // –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        function startGame() {
            socket.emit('startGame', roomId);
        }

        function rollDice() {
            socket.emit('rollDice', roomId);
        }

        function toggleDice(index) {
            socket.emit('toggleDice', { roomId, index });
        }

        function takePoints() {
            socket.emit('takePoints', roomId);
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                socket.emit('chatMessage', { roomId, message });
                input.value = '';
            }
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–π –∏–≥—Ä–µ –≤ ZONK! –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ${roomCode}\n${window.location.origin}/game/${roomId}`);
            alert('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–∑—å—è–º.');
        }

        function leaveGame() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã?')) {
                window.location.href = '/';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ —á–∞—Ç–µ
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZONK - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–≥—Ä–æ–∫–∏ -->
        <div class="players-panel">
            <h2>üéÆ –ò–≥—Ä–æ–∫–∏ <span id="playerCount">0/4</span></h2>
            <div id="playersList" class="player-list">
                <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            
            <div id="waitingArea" class="waiting-area">
                <h3>üë• –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</h3>
                <div class="room-info">
                    <div style="font-size: 0.9em; color: var(--text-secondary);">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</div>
                    <div id="roomCode" class="room-code">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <button onclick="copyRoomCode()" class="btn btn-primary" style="width: 100%; padding: 12px; margin: 10px 0;">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                    </button>
                </div>
                <button id="startGameBtn" onclick="startGame()" class="btn btn-success" style="width: 100%; padding: 15px; display: none;">
                    üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É (–º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞)
                </button>
            </div>

            <div id="gameControls" style="display: none; margin-top: 20px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <div style="font-size: 0.9em; color: var(--text-secondary);">–°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç:</div>
                    <div id="currentPlayer" style="font-size: 1.2em; font-weight: bold; color: var(--accent); margin-top: 5px;"></div>
                </div>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="game-area">
            <div class="game-title">
                <h1>üé≤ ZONK MULTIPLAYER</h1>
                <div id="gameStatus" class="subtitle">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–≥—Ä–µ...</div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ -->
            <div id="winnerMessage" class="win-message" style="display: none;">
                <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ -->
            <div id="currentPlayerArea" style="display: none; width: 100%;">
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">–ú–æ–∏ –æ—á–∫–∏</div>
                        <div id="myScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–û—á–∫–∏ —Ä–∞—É–Ω–¥–∞</div>
                        <div id="roundScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–ö–æ—Å—Ç–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞</div>
                        <div id="diceToRoll" class="score-value">6</div>
                    </div>
                </div>

                <div id="diceContainer" class="dice-container" style="display: none;">
                    <!-- –ö–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <div id="gameMessages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>

                <div id="playerControls" class="controls" style="display: none;">
                    <button id="rollBtn" onclick="rollDice()" class="btn btn-primary">
                        üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏
                    </button>
                    <button id="takeBtn" onclick="takePoints()" class="btn btn-success">
                        üí∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—á–∫–∏
                    </button>
                    <button onclick="leaveGame()" class="btn btn-danger">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è -->
            <div id="observerArea" style="display: none; text-align: center; padding: 40px; width: 100%;">
                <div style="font-size: 1.5em; color: var(--text-secondary); margin-bottom: 20px;">
                    üëÄ –í—ã –Ω–∞–±–ª—é–¥–∞–µ—Ç–µ –∑–∞ –∏–≥—Ä–æ–π
                </div>
                
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">–•–æ–¥ –∏–≥—Ä–æ–∫–∞</div>
                        <div id="observerCurrentPlayer" class="score-value">-</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–û—á–∫–∏ —Ä–∞—É–Ω–¥–∞</div>
                        <div id="observerRoundScore" class="score-value">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">–ö–æ—Å—Ç–∏ –¥–ª—è –±—Ä–æ—Å–∫–∞</div>
                        <div id="observerDiceToRoll" class="score-value">6</div>
                    </div>
                </div>
                
                <div id="observerDice" class="dice-container" style="margin: 30px 0;">
                    <!-- –ö–æ—Å—Ç–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è -->
                </div>
                
                <button onclick="leaveGame()" class="btn btn-danger" style="margin-top: 20px;">
                    üö™ –í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã
                </button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏ —á–∞—Ç -->
        <div class="combinations-panel">
            <h2>üéØ –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏</h2>
            
            <div class="combo-grid">
                <div class="combo-item">
                    <div class="combo-value">100</div>
                    <div class="combo-desc">–ó–∞ –∫–∞–∂–¥—É—é 1</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">50</div>
                    <div class="combo-desc">–ó–∞ –∫–∞–∂–¥—É—é 5</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">1000</div>
                    <div class="combo-desc">3 –µ–¥–∏–Ω–∏—Ü—ã</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">200</div>
                    <div class="combo-desc">3 –¥–≤–æ–π–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">300</div>
                    <div class="combo-desc">3 —Ç—Ä–æ–π–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">400</div>
                    <div class="combo-desc">3 —á–µ—Ç–≤–µ—Ä–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">500</div>
                    <div class="combo-desc">3 –ø—è—Ç–µ—Ä–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">600</div>
                    <div class="combo-desc">3 —à–µ—Å—Ç–µ—Ä–∫–∏</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">750</div>
                    <div class="combo-desc">3 –ø–∞—Ä—ã</div>
                </div>
                <div class="combo-item">
                    <div class="combo-value">1500</div>
                    <div class="combo-desc">–ü—Ä—è–º–∞—è (1-6)</div>
                </div>
            </div>

            <!-- –ß–∞—Ç -->
            <div class="chat-container">
                <h3>üí¨ –ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h3>
                <div id="chatMessages" class="chat-messages">
                    <div class="chat-message system">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="chat-input">
                    <button onclick="sendMessage()" class="btn btn-primary">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="debug-info">
        <div class="debug-line">Room: <span id="debugRoom"><%= roomId %></span></div>
        <div class="debug-line">Status: <span id="debugStatus">Connecting...</span></div>
        <div class="debug-line">Socket: <span id="debugSocketId">-</span></div>
        <div class="debug-line">My Turn: <span id="debugMyTurn">-</span></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const roomId = '<%= roomId %>';
        let myPlayerId = null;
        let isMyTurn = false;

        console.log('üéÆ Initializing game for room:', roomId);

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server with ID:', socket.id);
            myPlayerId = socket.id;
            
            document.getElementById('debugStatus').textContent = 'Connected';
            document.getElementById('debugSocketId').textContent = socket.id;
            document.getElementById('debugRoom').textContent = roomId;

            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
            if (roomId && roomId !== '') {
                console.log('üîó Joining room:', roomId);
                socket.emit('joinRoom', roomId);
            } else {
                console.error('‚ùå No room ID provided');
                window.location.href = '/';
            }
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from server');
            document.getElementById('debugStatus').textContent = 'Disconnected';
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå Connection error:', error);
            document.getElementById('debugStatus').textContent = 'Error';
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–≥—Ä–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
        socket.on('gameState', (gameState) => {
            console.log('üéÆ Game state updated:', gameState);
            updateGameState(gameState);
        });

        socket.on('playerJoined', (player) => {
            console.log('üë§ Player joined:', player);
            addChatMessage('system', `–ò–≥—Ä–æ–∫ ${player.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ`);
        });

        socket.on('playerLeft', (player) => {
            console.log('üë§ Player left:', player);
            addChatMessage('system', `–ò–≥—Ä–æ–∫ ${player.username} –≤—ã—à–µ–ª –∏–∑ –∏–≥—Ä—ã`);
        });

        socket.on('gameMessage', (data) => {
            console.log('üì¢ Game message:', data);
            handleGameMessage(data);
        });

        socket.on('chatMessage', (data) => {
            console.log('üí¨ Chat message:', data);
            addChatMessage(data.player, data.message);
        });

        socket.on('error', (message) => {
            console.error('üö® Error:', message);
            alert('–û—à–∏–±–∫–∞: ' + message);
        });

        // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateGameState(gameState) {
            updatePlayersList(gameState);
            updateRoomInfo(gameState);
            updateGameStatus(gameState);
            updateGameControls(gameState);
        }

        function updatePlayersList(gameState) {
            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');
            
            playersList.innerHTML = '';
            playerCount.textContent = `${gameState.players.length}/4`;
            
            gameState.players.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = `player-item ${index === gameState.currentPlayerIndex ? 'current-player' : ''}`;
                
                const isMe = player.id === myPlayerId;
                playerElement.innerHTML = `
                    <span class="player-name">
                        ${player.username} ${isMe ? ' (–í—ã)' : ''}
                        ${index === gameState.currentPlayerIndex ? ' üéØ' : ''}
                    </span>
                    <span class="player-score">${player.score}</span>
                `;
                
                playersList.appendChild(playerElement);
            });
        }

        function updateRoomInfo(gameState) {
            document.getElementById('roomCode').textContent = gameState.roomId;
        }

        function updateGameStatus(gameState) {
            const gameStatus = document.getElementById('gameStatus');
            const winnerMessage = document.getElementById('winnerMessage');
            const waitingArea = document.getElementById('waitingArea');
            const gameControls = document.getElementById('gameControls');
            
            if (gameState.status === 'waiting') {
                gameStatus.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤... (${gameState.players.length}/4)`;
                waitingArea.style.display = 'block';
                gameControls.style.display = 'none';
                winnerMessage.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞ –∏ —è —Å–æ–∑–¥–∞—Ç–µ–ª—å
                const canStart = gameState.players.length >= 2 && gameState.players[0].id === myPlayerId;
                document.getElementById('startGameBtn').style.display = canStart ? 'block' : 'none';
                
            } else if (gameState.status === 'playing') {
                gameStatus.textContent = '–ò–≥—Ä–∞ –∏–¥–µ—Ç!';
                waitingArea.style.display = 'none';
                gameControls.style.display = 'block';
                winnerMessage.style.display = 'none';
                
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                document.getElementById('currentPlayer').textContent = currentPlayer.username;
                
            } else if (gameState.status === 'finished') {
                gameStatus.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                winnerMessage.style.display = 'block';
                winnerMessage.innerHTML = `üèÜ –ü–û–ë–ï–î–ê!<br>${gameState.winner} –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç!`;
            }
        }

        function updateGameControls(gameState) {
            const currentPlayerArea = document.getElementById('currentPlayerArea');
            const observerArea = document.getElementById('observerArea');
            
            const myPlayer = gameState.players.find(p => p.id === myPlayerId);
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            isMyTurn = currentPlayer && currentPlayer.id === myPlayerId;
            
            document.getElementById('debugMyTurn').textContent = isMyTurn ? 'YES' : 'NO';
            
            if (myPlayer) {
                // –Ø –∏–≥—Ä–æ–∫
                currentPlayerArea.style.display = 'block';
                observerArea.style.display = 'none';
                
                document.getElementById('myScore').textContent = myPlayer.score;
                document.getElementById('roundScore').textContent = myPlayer.roundScore;
                document.getElementById('diceToRoll').textContent = myPlayer.diceToRoll;
                
                if (isMyTurn && gameState.status === 'playing') {
                    document.getElementById('playerControls').style.display = 'grid';
                    document.getElementById('diceContainer').style.display = 'grid';
                    updateMyDice(myPlayer.dice, myPlayer.selected);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                    document.getElementById('rollBtn').disabled = myPlayer.diceToRoll === 0;
                    const canTake = myPlayer.roundScore > 0 && (myPlayer.score > 0 || myPlayer.roundScore >= 300);
                    document.getElementById('takeBtn').disabled = !canTake;
                    
                } else {
                    document.getElementById('playerControls').style.display = 'none';
                    document.getElementById('diceContainer').style.display = 'none';
                }
            } else {
                // –Ø –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
                currentPlayerArea.style.display = 'none';
                observerArea.style.display = 'block';
                
                document.getElementById('observerCurrentPlayer').textContent = currentPlayer.username;
                document.getElementById('observerRoundScore').textContent = currentPlayer.roundScore;
                document.getElementById('observerDiceToRoll').textContent = currentPlayer.diceToRoll;
                updateObserverDice(currentPlayer.dice, currentPlayer.selected);
            }
        }

        function updateMyDice(dice, selected) {
            const container = document.getElementById('diceContainer');
            container.innerHTML = '';
            
            dice.forEach((value, index) => {
                const diceElement = document.createElement('div');
                diceElement.className = `dice ${selected[index] ? 'selected' : ''}`;
                diceElement.innerHTML = `<span class="dice-value">${value}</span>`;
                
                if (isMyTurn && !selected[index]) {
                    diceElement.style.cursor = 'pointer';
                    diceElement.onclick = () => toggleDice(index);
                } else {
                    diceElement.style.cursor = 'default';
                }
                
                container.appendChild(diceElement);
            });
        }

        function updateObserverDice(dice, selected) {
            const container = document.getElementById('observerDice');
            container.innerHTML = '';
            
            dice.forEach((value, index) => {
                const diceElement = document.createElement('div');
                diceElement.className = `dice ${selected[index] ? 'selected' : ''}`;
                diceElement.innerHTML = `<span class="dice-value">${value}</span>`;
                diceElement.style.cursor = 'default';
                container.appendChild(diceElement);
            });
        }

        // –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        function startGame() {
            console.log('üöÄ Starting game in room:', roomId);
            socket.emit('startGame', roomId);
        }

        function rollDice() {
            console.log('üé≤ Rolling dice in room:', roomId);
            socket.emit('rollDice', roomId);
        }

        function toggleDice(index) {
            console.log('üéØ Toggling dice:', index);
            socket.emit('toggleDice', { roomId, index });
        }

        function takePoints() {
            console.log('üí∞ Taking points in room:', roomId);
            socket.emit('takePoints', roomId);
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                console.log('üí¨ Sending message:', message);
                socket.emit('chatMessage', { roomId, message });
                input.value = '';
            }
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('roomCode').textContent;
            const inviteText = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–π –∏–≥—Ä–µ –≤ ZONK! –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ${roomCode}\n${window.location.origin}/game/${roomId}`;
            
            navigator.clipboard.writeText(inviteText).then(() => {
                addChatMessage('system', '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–∑—å—è–º.');
            }).catch(() => {
                alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + inviteText);
            });
        }

        function leaveGame() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã?')) {
                window.location.href = '/';
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function addChatMessage(sender, message) {
            const chat = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            
            if (sender === 'system') {
                messageElement.className = 'chat-message system';
                messageElement.textContent = message;
            } else {
                messageElement.className = 'chat-message';
                messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            }
            
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function handleGameMessage(data) {
            let message = '';
            
            switch(data.type) {
                case 'zonk':
                    message = `üí• ${data.player} –ø–æ–ª—É—á–∏–ª ZONK! –û—á–∫–∏ —Ä–∞—É–Ω–¥–∞ –ø–æ—Ç–µ—Ä—è–Ω—ã.`;
                    break;
                case 'hotDice':
                    message = `üéâ ${data.player} –ø–æ–ª—É—á–∏–ª Hot Dice! –ë—Ä–æ—Å–∞–µ—Ç —Å–Ω–æ–≤–∞ –≤—Å–µ 6 –∫–æ—Å—Ç–µ–π.`;
                    break;
                case 'takePoints':
                    message = `üí∞ ${data.player} –≤–∑—è–ª ${data.score} –æ—á–∫–æ–≤.`;
                    break;
                case 'win':
                    message = `üèÜ ${data.player} –ø–æ–±–µ–∂–¥–∞–µ—Ç —Å ${data.score} –æ—á–∫–∞–º–∏!`;
                    break;
            }
            
            if (message) {
                addChatMessage('system', message);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏—à
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        setInterval(() => {
            if (!socket.connected) {
                document.getElementById('debugStatus').textContent = 'Reconnecting...';
            }
        }, 5000);
    </script>
</body>
</html>
